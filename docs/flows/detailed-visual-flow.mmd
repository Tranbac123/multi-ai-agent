graph TB
    %% User Interface Layer
    subgraph "ğŸ‘¤ User Interface Layer"
        User["ğŸ‘¤ User"]
        Browser["ğŸŒ Web Browser"]
        Mobile["ğŸ“± Mobile App"]
    end

    %% Frontend Services
    subgraph "ğŸ¨ Frontend Services"
        ChatbotUI["ğŸ¤– AI Chatbot UI<br/>:3001<br/>React + Real-time Search"]
        WebFrontend["ğŸŒ Web Frontend<br/>:3000<br/>React/Vite Dashboard"]
        AdminPortal["âš™ï¸ Admin Portal<br/>:8099<br/>FastAPI Backend"]
    end

    %% API Gateway Layer
    subgraph "ğŸšª API Gateway Layer"
        APIGateway["ğŸšª API Gateway<br/>:8000<br/>Authentication â€¢ Rate Limiting<br/>Request Routing â€¢ CORS"]
    end

    %% Core Processing Layer
    subgraph "ğŸ§  Core Processing Layer"
        RouterService["ğŸ¯ Router Service<br/>:8083<br/>Intelligent Routing<br/>Feature Extraction<br/>Tier Classification"]
        
        Orchestrator["ğŸ¼ Orchestrator<br/>:8081<br/>Workflow Execution<br/>LangGraph â€¢ Saga Patterns<br/>Loop Safety â€¢ Tool Coordination"]
        
        ModelGateway["ğŸ¤– Model Gateway<br/>:8080<br/>AI Model Routing<br/>Provider Management<br/>Cost Optimization"]
    end

    %% Data & Tools Layer
    subgraph "ğŸ”§ Data & Tools Layer"
        RetrievalService["ğŸ“š Retrieval Service<br/>:8081<br/>Document Retrieval<br/>RAG â€¢ Vector Search<br/>Semantic Analysis"]
        
        ToolsService["ğŸ› ï¸ Tools Service<br/>:8082<br/>External Tools<br/>FIRECRAWL Web Search<br/>API Integrations"]
        
        ChatAdapters["ğŸ’¬ Chat Adapters<br/>:8006<br/>Multi-channel Integration<br/>Facebook â€¢ Zalo â€¢ TikTok<br/>Webhook Processing"]
    end

    %% Real-time Layer
    subgraph "âš¡ Real-time Layer"
        RealtimeGateway["âš¡ Realtime Gateway<br/>:8084<br/>WebSocket Connections<br/>Message Streaming<br/>Backpressure Management"]
        
        SemanticCache["ğŸ§  Semantic Cache<br/>:8085<br/>Intelligent Caching<br/>Response Optimization<br/>Similarity Matching"]
    end

    %% Control Plane
    subgraph "ğŸ›ï¸ Control Plane"
        ConfigService["âš™ï¸ Config Service<br/>:8090<br/>Configuration Management<br/>Environment Settings<br/>Feature Toggles"]
        
        PolicyAdapter["ğŸ“‹ Policy Adapter<br/>:8091<br/>Policy Enforcement<br/>Compliance Management<br/>Access Control"]
        
        FeatureFlags["ğŸš© Feature Flags<br/>:8092<br/>Runtime Toggles<br/>A/B Testing<br/>Canary Deployments"]
        
        UsageMetering["ğŸ“Š Usage Metering<br/>:8095<br/>Usage Tracking<br/>Cost Monitoring<br/>Budget Enforcement"]
        
        AuditLog["ğŸ“ Audit Log<br/>:8096<br/>Activity Tracking<br/>Compliance Logging<br/>Security Events"]
    end

    %% Infrastructure Layer
    subgraph "ğŸ—ï¸ Infrastructure Layer"
        Postgres["ğŸ˜ PostgreSQL<br/>:5432<br/>Primary Database<br/>Multi-tenant RLS<br/>ACID Compliance"]
        
        Redis["ğŸ”´ Redis<br/>:6379<br/>Session Storage<br/>Caching Layer<br/>Pub/Sub Messaging"]
        
        NATS["ğŸ“¡ NATS JetStream<br/>:4222<br/>Event Streaming<br/>Message Queuing<br/>Guaranteed Delivery"]
        
        VectorDB["ğŸ§® Vector Database<br/>Embeddings Storage<br/>Semantic Search<br/>Similarity Matching"]
    end

    %% External Services
    subgraph "ğŸŒ External Services"
        OpenAI["ğŸ§  OpenAI API<br/>GPT Models<br/>Text Generation"]
        
        Anthropic["ğŸ¤– Anthropic API<br/>Claude Models<br/>Advanced Reasoning"]
        
        FIRECRAWL["ğŸ•·ï¸ FIRECRAWL API<br/>Web Scraping<br/>Live Data Search"]
        
        Stripe["ğŸ’³ Stripe API<br/>Payment Processing<br/>Billing Management"]
        
        SocialPlatforms["ğŸ“± Social Platforms<br/>Facebook Messenger<br/>Zalo Chat â€¢ TikTok<br/>Webhook Endpoints"]
    end

    %% User Journey - Main Flow
    User --> Browser
    User --> Mobile
    Browser --> ChatbotUI
    Browser --> WebFrontend
    Mobile --> ChatbotUI

    %% Frontend to API Gateway
    ChatbotUI -->|"POST /ask<br/>JSON Request<br/>Session Management"| APIGateway
    WebFrontend -->|"REST API Calls<br/>Authentication<br/>CORS Headers"| APIGateway
    AdminPortal -->|"Admin APIs<br/>Management Operations<br/>User Administration"| APIGateway

    %% API Gateway Processing
    APIGateway -->|"JWT Validation<br/>Rate Limiting<br/>Tenant Context"| ConfigService
    APIGateway -->|"Policy Checks<br/>Access Control<br/>Compliance"| PolicyAdapter
    APIGateway -->|"Feature Flags<br/>A/B Testing<br/>Runtime Toggles"| FeatureFlags

    %% Core Processing Flow
    APIGateway -->|"Intelligent Routing<br/>Feature Extraction<br/>Tier Selection"| RouterService
    RouterService -->|"Workflow Execution<br/>Multi-step Processing<br/>Tool Coordination"| Orchestrator
    Orchestrator -->|"AI Model Requests<br/>Provider Selection<br/>Cost Optimization"| ModelGateway

    %% Data & Tools Processing
    Orchestrator -->|"Document Retrieval<br/>Vector Search<br/>RAG Processing"| RetrievalService
    Orchestrator -->|"External Tools<br/>Web Search<br/>API Integrations"| ToolsService
    
    %% Real-time Communication
    APIGateway -->|"WebSocket Upgrade<br/>Real-time Streaming<br/>Message Queues"| RealtimeGateway
    APIGateway -->|"Response Caching<br/>Similarity Matching<br/>Performance Optimization"| SemanticCache

    %% External API Calls
    ModelGateway -->|"GPT Completions<br/>Text Generation<br/>Token Usage"| OpenAI
    ModelGateway -->|"Claude Completions<br/>Advanced Reasoning<br/>Multi-modal"| Anthropic
    ToolsService -->|"Web Scraping<br/>Live Data Search<br/>Content Extraction"| FIRECRAWL

    %% Social Platform Integration
    SocialPlatforms -->|"Webhook Messages<br/>Platform Events<br/>User Interactions"| ChatAdapters
    ChatAdapters -->|"Normalized Messages<br/>Platform Abstraction<br/>Response Routing"| APIGateway

    %% Infrastructure Dependencies
    APIGateway -->|"Data Persistence<br/>Multi-tenant Storage<br/>ACID Transactions"| Postgres
    APIGateway -->|"Session Management<br/>Caching Layer<br/>Pub/Sub Events"| Redis
    APIGateway -->|"Event Streaming<br/>Message Queuing<br/>Reliable Delivery"| NATS
    
    RetrievalService -->|"Vector Storage<br/>Embedding Indexing<br/>Similarity Search"| VectorDB
    RetrievalService -->|"Document Storage<br/>Metadata Management<br/>RLS Isolation"| Postgres
    
    RealtimeGateway -->|"Session Storage<br/>Message Buffering<br/>Connection Management"| Redis
    RealtimeGateway -->|"Event Broadcasting<br/>Real-time Updates<br/>Message Streaming"| NATS

    %% Control Plane Dependencies
    ConfigService -->|"Configuration Storage<br/>Environment Variables<br/>Settings Cache"| Redis
    PolicyAdapter -->|"Policy Cache<br/>Decision Storage<br/>Access Rules"| Redis
    FeatureFlags -->|"Flag State<br/>A/B Test Data<br/>Toggle History"| Redis
    UsageMetering -->|"Usage Data<br/>Billing Events<br/>Cost Tracking"| Postgres
    AuditLog -->|"Audit Events<br/>Compliance Logs<br/>Security Trails"| Postgres

    %% Billing Integration
    UsageMetering -->|"Payment Processing<br/>Invoice Generation<br/>Subscription Management"| Stripe

    %% Monitoring & Analytics
    APIGateway -->|"Usage Tracking<br/>Cost Monitoring<br/>Performance Metrics"| UsageMetering
    APIGateway -->|"Activity Logging<br/>Security Events<br/>Compliance Tracking"| AuditLog

    %% Event Publishing
    APIGateway -.->|"Usage Events<br/>tenant.usage.*"| NATS
    APIGateway -.->|"Audit Events<br/>tenant.audit.*"| NATS
    ModelGateway -.->|"Model Events<br/>model.usage.*"| NATS
    ToolsService -.->|"Tool Events<br/>tool.execution.*"| NATS
    UsageMetering -.->|"Billing Events<br/>tenant.billing.*"| NATS

    %% Response Flow
    ModelGateway -->|"AI Response<br/>Generated Content<br/>Usage Metrics"| APIGateway
    RetrievalService -->|"Document Results<br/>Relevance Scores<br/>Source Citations"| APIGateway
    ToolsService -->|"Tool Output<br/>External Data<br/>Execution Metrics"| APIGateway
    
    APIGateway -->|"Final Response<br/>Citations â€¢ Trace<br/>Usage Data"| ChatbotUI
    APIGateway -->|"API Response<br/>JSON Data<br/>Status Codes"| WebFrontend
    APIGateway -->|"Admin Response<br/>Management Data<br/>System Status"| AdminPortal

    %% Real-time Updates
    RealtimeGateway -->|"WebSocket Messages<br/>Real-time Updates<br/>Streaming Response"| ChatbotUI

    %% Styling
    classDef userLayer fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    classDef frontendLayer fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef gatewayLayer fill:#fff3e0,stroke:#f57c00,stroke-width:3px
    classDef coreLayer fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef dataLayer fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef realtimeLayer fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    classDef controlLayer fill:#fff8e1,stroke:#fbc02d,stroke-width:2px
    classDef infraLayer fill:#efebe9,stroke:#5d4037,stroke-width:2px
    classDef externalLayer fill:#ffebee,stroke:#d32f2f,stroke-width:2px

    class User,Browser,Mobile userLayer
    class ChatbotUI,WebFrontend,AdminPortal frontendLayer
    class APIGateway gatewayLayer
    class RouterService,Orchestrator,ModelGateway coreLayer
    class RetrievalService,ToolsService,ChatAdapters dataLayer
    class RealtimeGateway,SemanticCache realtimeLayer
    class ConfigService,PolicyAdapter,FeatureFlags,UsageMetering,AuditLog controlLayer
    class Postgres,Redis,NATS,VectorDB infraLayer
    class OpenAI,Anthropic,FIRECRAWL,Stripe,SocialPlatforms externalLayer
