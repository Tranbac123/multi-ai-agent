name: "Api Gateway CI/CD"

on:
  push:
    paths:
      - "apps/api-gateway/**"
      - "libs/**"
      - "contracts/**"
      - "platform/ci-templates/**"
      - ".github/workflows/api-gateway-*.yaml"
  pull_request:
    paths:
      - "apps/api-gateway/**"
      - "libs/**"
      - "contracts/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: "Build and Test Api Gateway"
    uses: ./platform/ci-templates/service-ci.yaml
    with:
      language: "python"
      service_path: "apps/api-gateway"
      service_name: "api-gateway"
      enable_docker: true
      enable_sbom: true
    secrets:
      DOCKER_REGISTRY_URL: ${{ secrets.DOCKER_REGISTRY_URL }}
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  # Optional: Service-specific deployment to dev environment
  deploy-dev:
    name: "Deploy to Development"
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to development
        run: |
          echo "Deploying api-gateway to development environment"
          # Add your deployment logic here
          # cd apps/api-gateway/deploy
          # make deploy ENV=dev IMAGE_TAG=${{ github.sha }}
